#!/usr/bin/env perl

# TODO: Change things to run as non-root

use FindBin;
use lib "$FindBin::Bin/../perl/";
use KBDeploy;
use strict;

my $hashfile;

my $DF="/root/deploy.done";

$hashfile=shift @ARGV if ($ARGV[0] ne '-f' && $ARGV[0] ne '-b');
exit if $ARGV[0] eq 'bootstrap';

my $cfg=read_config();

my @sl=myservices();
exit unless scalar(@sl);

mkdocs(@sl);
exit if -e $DF && $ARGV[0] ne '-f';
#
# redploy_service will tell us if we need to repeploy but
# it also populates that hashes to deploy
my $redeploy=KBDeploy::redeploy_service("../$hashfile",@sl);
exit unless $redeploy;

stop_service(@sl);

deploy_service('deploy',@sl);

start_service(@sl);
open(D,"> $DF");
print D "Done\n";
close D;
